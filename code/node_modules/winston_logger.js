const winston = require('winston')
const {logLevel, unformattedLogs} = require('env_vars')


const TIMESTAMP_FORMAT = 'YYYY-MM-DD HH:mm:ss'

function newLogger(namespace) {
    let logFormat = setFormat(namespace)

    return winston.createLogger({
        format: winston.format.combine(
            winston.format.timestamp({
                format: TIMESTAMP_FORMAT,
            }),
            logFormat
        ),
        transports: [
            new winston.transports.Console({
                level: logLevel,
                format: winston.format.combine(
                    winston.format.timestamp({
                        format: TIMESTAMP_FORMAT,
                    }),
                    winston.format.colorize(),
                    logFormat
                ),
                // this should work, but waiting to test it until default succeeds
                filters: [
                    function (level, msg, meta) {
                        return `[${namespace}] ${msg}`
                    }
                ]
            }),
        ],
    })
}

function setFormat(namespace) {
    return winston.format.printf(function(info) {
        if (unformattedLogs)
            return info.message
        let date = new Date().toISOString()
        let message = JSON.stringify(info.message, null, 4)
        return `${namespace}-${info.level}: ${message} [${date}]\n`;
    });
}


module.exports = {
    newLogger : newLogger
}